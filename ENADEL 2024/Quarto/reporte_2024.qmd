---
title: ""
author: ""
format:
  pdf:
    cap-location: "top"
    keep-tex: true
    fig-pos: 'H'
    document:
      tables:
        float: false
    extra_dependencies: ["pdfpages", "float"]  
    documentclass: article
    latex-engine: xelatex
    toc: false
    toc-depth: 3
    toc-title: "Índice"
    mainfont: "Aptos"
fontsize: 11pt
lang: es
header-includes:
  - \usepackage{pdfpages}  
  - \usepackage{fontspec}
  - \usepackage[bottom]{footmisc} 
  - \setmainfont{Aptos}[Path="C:/Users/ginow/AppData/Roaming/TinyTeX/texmf-dist/fonts/truetype/aptos/", Extension=".ttf"]
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - |
    \fancyhead[C]{\makebox[\textwidth]{\hspace*{-1cm}\includegraphics[height=1.9cm]{../Logotipo ENADEL/encabezado_izquierda1.png} \hfill \includegraphics[height=1.5cm]{../Logotipo ENADEL/encabezado_derecha.png} \hspace*{-2cm}}}
  - \fancyfoot[L]{Subsecretaría del Trabajo}
  - \cfoot{\thepage}
  - \setlength{\footskip}{10pt}
  - \setlength{\skip\footins}{15pt} 
  - \setlength{\headheight}{3cm}  # ajusta según sea necesario
  - \setlength{\headsep}{0.5cm}  # distancia del encabezado al cuerpo del texto
  - \renewcommand{\footrulewidth}{0pt} 
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
  - \usepackage{geometry}
  - \geometry{
      left=3cm,
      right=3cm,
      top=2.5cm,
      bottom=2.5cm
    }
  - \usepackage{placeins}
  - \usepackage{ragged2e}
  - \usepackage{float}
  - \usepackage{setspace}
  - \renewcommand{\familydefault}{\sfdefault}
  - \AtBeginDocument{\renewcommand{\baselinestretch}{1.5}\justifying}
  - \usepackage{xcolor}
  - \usepackage{pagecolor}
include-before-body: "portada.tex"
---
\definecolor{customblue}{HTML}{12468d}


\pagecolor{customblue} 
\thispagestyle{empty} 
\color{white} 
 

::: titlingpage
\centering
\includegraphics[width=0.5\textwidth]{../Logotipo ENADEL/Logotipo ENADEL-02.png} \vspace{2cm}
:::

\noindent
Ministerio del Trabajo y Previsión Social

Departamento de intermediación y prospección laboral\\
Subsecretaría del Trabajo



\justifying
El presente documento analiza los resultados de la Encuesta Nacional de Demanda Laboral (ENADEL) 2024, que busca identificar y caracterizar el capital humano requerido por las empresas de los distintos sectores productivos del país, generando información sobre la demanda actual de ocupaciones de las empresas, detectando requisitos y problemas de contratación. A diferencia de las versiones anteriores de esta encuesta, la actual versión abarca 15 sectores de actividad económica, ayuda a identificar prioridades de capacitación y se añade el foco sobre el impacto que está teniendo la incorporación de nuevas tecnologías y los eventos climáticos extremos sobre los trabajadores.








\newpage
\nopagecolor
\color{black}
\renewcommand{\contentsname}{Índice} 
\tableofcontents

\newpage

## Capítulo I: Contexto y caracterización de empresas

El primer capítulo se centra en contextualizar y caracterizar a las empresas participantes de la Encuesta Nacional de Demanda Laboral (ENADEL) 2024. En este apartado se busca comprender la estructura y distribución de las empresas a nivel nacional, diferenciando por tamaño, sector productivo y dotación de personal. 

Asimismo, se examinan características relevantes de las empresas que configuran la base del mercado laboral actual, con el fin de establecer un panorama detallado sobre la composición y dinámica de los sectores productivos. Este análisis otorga un marco inicial para interpretar la demanda laboral en los siguientes capítulos, destacando patrones y diferencias que permiten identificar regiones y sectores de mayor demanda laboral así como los desafíos futuros asociados a la generación de empleo en el país. 


\FloatBarrier

### Regiones y ubicación de sucursales 

```{r eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', fig.align = 'center'}

options(scipen = 999)

#Cargar paquetes
pacman::p_load(survey,
               tidyverse,#universo de paquetes
               haven,# leer archivos stata y spss
               stargazer,# tablas de regresión??
              kableExtra,#Tablas fancy
              scales,#escala porcentaje 
              patchwork,#Combinar gráficos
              bookdown,#Referencias
              showtext,#fuente
              sysfonts,#habilitar fuentes
              forcats,
              rnaturalearth,#mapas
              rnaturalearthdata,
              devtools,
              sf)#maps


#datos
enadel <- read_dta("../Bases/enadel_2024.dta")
# Dejar -88 como perdido
enadel <- enadel %>%
  mutate_at(vars(starts_with("b")), ~ ifelse(is.numeric(.) & . == -88, NA, .))



#Diseño muestral
#svy
options(survey.lonely.psu="adjust")
design_enadel_2024 <- svydesign(ids = ~id_emp, strata =~estrato ,  weights = ~fact_emp, data = enadel, nest = TRUE)

 #Cantidad de empresas
 tot_folios <- svytotal(~empresas, design_enadel_2024, na.rm = TRUE)[1]
 tot_folios_muestra <- length(unique(enadel$id_emp))

 # total trabajadores 
  tot_trab <- svytotal(~b6_1, design_enadel_2024, na.rm = TRUE)[1]
  tot_trab_muestra <- sum(enadel$b6_1)
        
  
  
tot_folios_muestra <- format(length(unique(enadel$id_emp)), scientific = FALSE)
tot_trab_muestra <- format(sum(enadel$b6_1), scientific = FALSE)


options(OutDec = ",")

#Cargar tablas


porc_region <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "pc_region")


  orden_regiones <- c(
    "Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", 
    "Coquimbo", "Valparaíso", "Metropolitana", "O'Higgins", 
    "Maule", "Ñuble", "Biobío", "La Araucanía", 
    "Los Ríos", "Los Lagos", "Aysén", "Magallanes"
  )

porc_region<- porc_region %>% select(-c("region","empresas", "trabajadores")) 

porc_region <- round(porc_region*100, 1)
rownames(porc_region)<- orden_regiones

tot_folios<- as.data.frame(tot_folios)
tot_trab <- as.data.frame(tot_trab)

```

La muestra de ENADEL 2024 encuesta a `r tot_folios_muestra` empresas que suman `r tot_trab_muestra` trabajadores (a nivel muestral). Estas representan a `r round(tot_folios[1,1],0)` empresas y  `r round(tot_trab[1,1],0)` trabajadores a nivel nacional. 

La @tbl-region muestra  la distribución en las distintas regiones del país, dónde la Macrozona norte^[La macrozona norte corresponde a las regiones de Arica y Parinacota, Tarapacá, Antofagasta y Atacama. La macrozona centro incluye las regiones de Coquimbo y Valparaíso. La macrozona centro-sur abarca las regiones de O’Higgins, Maule, Ñuble y Biobío. La macrozona sur comprende las regiones de La Araucanía, Los Ríos y Los Lagos. Finalmente, la macrozona austral corresponde a las regiones de Aysén y Magallanes.] representa un total de `r porc_region[1, 1] + porc_region[2, 1] + porc_region[3, 1] + porc_region[4, 1]`% de las empresas del país y un `r porc_region[1, 2] + porc_region[2, 2] + porc_region[3, 2] + porc_region[4, 2]`% del total de trabajadores.
En la Macrozona centro se ubican el `r porc_region[5, 1]  + porc_region[6, 1]`% de las empresas y el  `r porc_region[5, 2] + porc_region[6, 2]`% de los trabajadores.
Un `r porc_region[7, 1]`% de las empresas y un `r porc_region[7, 2]`% de los trabajadores se encuentran en la región Metropolitana.
La Macrozonza Centro Sur contempla el `r porc_region[8, 1] + porc_region[9, 1] + porc_region[10, 1] + porc_region[11, 1]`% de las empresas y al `r porc_region[8, 2] + porc_region[9, 2] + porc_region[10, 2] + porc_region[11, 2]`% de trabajadores del país.
Por su parte, un  `r porc_region[12, 1] + porc_region[13, 1] + porc_region[14, 1]`% de las empresas del país se encuentran en la Macrozona Sur, la que comprende al `r porc_region[12, 2]+ porc_region[13, 2] + porc_region[14, 2]`% de los trabajadores a nivel nacional.

Por último, en la Macrozona Austral se encuentran el `r porc_region[15, 1]+ porc_region[16, 1]`% de las empresas y el `r porc_region[15, 2]+ porc_region[16, 2]`% de los trabajadores de Chile.

\vspace{5mm}

\FloatBarrier
```{r, results='asis'}
#| label: tbl-region
#| tbl-cap: "Resultados de la encuesta" 
#| echo: false
#| error: false
#| message: false
#| warning: false

porc_region <- porc_region %>% mutate(pc_empresas = paste0(pc_empresas, "%"),
                                      pc_trabajadores = paste0(pc_trabajadores, "%"))

# Generar la tabla con kable
kable(porc_region,
      col.names = c("Región", "% Empresas", "% Trabajadores"),
      format = "latex",
      booktabs = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = "Aptos") %>%
  column_spec(1, width = "6cm") %>%
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "3cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
           general_title= "")


```


```{r eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', fig.align = 'center'}


pc_regiones_sucursal <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "pc_regiones_sucursal")

orden_regiones_sucursal <-pc_regiones_sucursal |> arrange(desc(total))


# Descargar un shapefile de Chile
library(devtools)
#devtools::install_github("ropensci/rnaturalearthhires")
chile_map <- ne_states(country = "Chile", returnclass = "sf")

chile_map <- dplyr::rename(chile_map, Region = name)


```
\newpage

La @fig-mapa-sucursal ilustra las regiones donde las empresas tienen sucursales, las regiones con más cantidad de sucursales que corresponden a sedes no principales son `r (orden_regiones_sucursal[1,3])`, `r (orden_regiones_sucursal[2,3])` y   `r (orden_regiones_sucursal[3,3])` con un total de `r (orden_regiones_sucursal[1,1])`, `r (orden_regiones_sucursal[2,1])` y  `r (orden_regiones_sucursal[3,1])`  sucursales respectivamente. Por su parte, las regiones de `r (orden_regiones_sucursal[14,3])`, `r (orden_regiones_sucursal[15,3])` y   `r (orden_regiones_sucursal[16,3])`  registran la menor presencia de sucursales regionales de las empresas, con `r (orden_regiones_sucursal[14,1])` o menos dependencias.

\FloatBarrier
```{r, fig.cap="Porcentajes de sucursales en cada región",  fig.align='center', fig.pos='H'}
#| fig-width: 10
#| fig-height: 12
#| dpi: 300
#| label: fig-mapa-sucursal
#| fig-cap: "Sucursales por región"
#| echo: false
#| fig-align: center
#| error: false
#| message: false
#| warning: false

# Unir los datos espaciales con el dataframe

map_data <- chile_map %>%
  left_join(pc_regiones_sucursal, by = "Region")


# Crear centroides y ajustar posiciones para las etiquetas
map_data <- map_data %>%
  mutate(centroid = st_centroid(geometry)) %>% # Calcular centroides
  mutate(
    label_coords_x = st_coordinates(centroid)[, 1] - 3, # Ajustar posición X (hacia la izquierda)
    label_coords_y = st_coordinates(centroid)[, 2]        # Mantener posición Y igual al centroide
  )

# Crear el gráfico
ggplot(data = map_data) +
  geom_sf(aes(fill = `total`), color = "white") + # Mapa base con relleno
  geom_segment(aes(
    x = st_coordinates(centroid)[, 1], # Punto inicial (X del centroide)
    y = st_coordinates(centroid)[, 2], # Punto inicial (Y del centroide)
    xend = label_coords_x,             # Punto final (X ajustado)
    yend = label_coords_y              # Punto final (Y del centroide, sin ajuste)
  ), color = "gray", size = 0.5) + # Líneas horizontales
   geom_point(aes(
    x = st_coordinates(centroid)[, 1],
    y = st_coordinates(centroid)[, 2]
  ), color = "white", size = 2) +
  geom_text(aes(
    x = label_coords_x, # Coordenada X ajustada
    y = label_coords_y, # Coordenada Y sin ajuste
    label = paste(Region, total, sep = ": ") # Etiqueta con región y total
  ), color = "black", size = 4, hjust = 1) + # Etiquetas alineadas a la izquierda
  scale_fill_gradient(low = "#64c3d2", high = "#002a51", name = "Total de sucursales") +
  labs(
    title = "",
    caption = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    plot.caption = element_text(size = 12, hjust = 0.5)
  ) +
  coord_sf(xlim = c(-90, -65), ylim = c(-56, -19))


```
\FloatBarrier

### Tamaño de empresas (n° de ventas y n° de trabajadores)

```{r eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', fig.align = 'center'}

options(OutDec = ",")

pc_tam<- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "pc_tam")
pc_tam<-as.data.frame(pc_tam)

pc_tamvent<- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "pc_tamvent")
pc_tamvent<- as.data.frame(pc_tamvent)
```


La @fig-combined muestra como se distribuyen las empresas por tamaño de empresa, el panel de la izquierda muestra los porcentajes acorde al tamaño de las empresas según su número de trabajadores. Y en el panel de la derecha, se aprecia la distribución de las empresas por tamaño según el volumen de venta de estas. 

Con respecto a la primera clasificación, el `r round(pc_tam[1,4]*100,1)`% de las empresas tiene menos de 50 trabajadores -que representa el `r round(pc_tam[1,5]*100,1)`% de los trabajadores-. Un `r round(pc_tam[2,4]*100,1)`% de las empresas son medianas de tamaño (entre 50 y 199 trabajadores), dentro de estas organizaciones se encuentra el  `r round(pc_tam[2,5]*100,1)`% de los trabajadores del país. Y un `r round(pc_tam[3,4]*100,1)`% de las empresas corresponde a empresas grandes con 200 trabajadores o más, lo que equivale al `r round(pc_tam[3,5]*100,1)`% del total de trabajadores.

Si se analiza según tamaño de ventas, un `r round(pc_tamvent[2,4]*100,1)`%  de las empresas tienen un volumen de venta menores a 2.400 UF (microempresa), el `r round(pc_tamvent[3,4]*100,1)`% posee un volumen de venta anual entre  2.400 y 24.999 UF (“Pequeñas”) y el `r round(pc_tamvent[4,4]*100,1)`% venden entre 25.000 y 100.000 UF al año (“Mediana”). Sin embargo, el `r round(max(pc_tamvent[5])*100,1)`% de los trabajadores están en empresas grandes (más de 100.000 UF).




\FloatBarrier
```{r, fig.cap="Gráfico combinado de resultados", out.width='100%', fig.align='center', fig.pos='H'}
#| label: fig-combined
#| fig-cap: "Gráfico combinado de resultados"
#| echo: false
#| fig-align: center
#| error: false
#| message: false
#| warning: false


#Agregar Aptos
#font_add(family = "Aptos", regular = "C:/Windows/Fonts/APTOS.TTF")
#habilitar para ggplot
showtext_auto()

#Gráfico de tamaño según n° de trabajadores----

# Transformar los datos al formato largo para ggplot
df_long <- pc_tam %>%
  pivot_longer(cols = starts_with("pc_"), names_to = "tipo", values_to = "porcentaje")
# Cambiar nombres
df_long$tipo <- recode(df_long$tipo, "pc_empresas" = "Empresas", "pc_trabajadores" = "Trabajadores")


# Gráfico de barras
graf_tam<-ggplot(df_long, aes(x = tipo, y = porcentaje, fill = factor(tam_label, levels = c("Pequeña", "Mediana", "Grande")))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.5), width = 0.4) +#gráfico de barras
  scale_fill_manual(values = c("Pequeña" = "#e36444", "Mediana" = "#c36c9b", "Grande" = "#35638c")) +#color de leyendas
  geom_text(aes(label = scales::percent(porcentaje, accuracy = 1)),#valor de etiquetas
            position = position_dodge(width = 0.5), vjust = -0.5, size = 2.3) +#posición de las etiquetas
   scale_y_continuous(labels = scales::percent, limits = c(0, 0.85)) + #eje y
  labs(title = "Según N° de trabajadores",
       x = NULL,
       y = NULL,
       fill = "") +
  theme_minimal(base_family = "Aptos") +
  theme(axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 6),
        plot.title = element_text(hjust = 0.5, size = 7.5),
        legend.position = "bottom",
        legend.title = element_text(size = 5), # Ajustar el tamaño del título de la leyenda
    legend.text = element_text(size = 5.5)    # Ajustar el tamaño del texto de las etiquetas de la leyenda
  ) +
  guides(
    fill = guide_legend(nrow = 2) # Configurar la leyenda para tener 2 filas
  )



#Gráfico de tamaño según n° de ventas----

#Transformar los datos al formato largo para ggplot
pc_tamvent <- pc_tamvent |> mutate(a3=case_when(a3==1~"Sin ventas",
                                             a3==2~"Micro",
                                             a3==3~"Pequeña",
                                             a3==4~"Mediana",
                                             a3==5~"Grande",
                                             TRUE ~ NA
                                             ))|> filter(!is.na(a3))

df_long<- pc_tamvent|> pivot_longer(cols = starts_with("pc_"), names_to = "tipo", values_to = "porcentaje")
# Cambiar nombres
df_long$tipo <- recode(df_long$tipo, "pc_empresas" = "Empresas", "pc_trabajadores" = "Trabajadores")


# Gráfico de barras
graf_tamvent<-ggplot(df_long, aes(x = tipo, y = porcentaje, fill = factor(a3, levels = c("Sin ventas","Micro","Pequeña", "Mediana", "Grande")))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +#gráfico de barras
  scale_fill_manual(values = c("Sin ventas"= "#bb1c42","Micro"="#f4bb54","Pequeña" = "#e36444", "Mediana" = "#c36c9b", "Grande" = "#35638c")) +#color de leyendas
  geom_text(aes(label = scales::percent(porcentaje, accuracy = 1)),#valor de etiquetas
            position = position_dodge(width = 0.7), vjust = -0.5, size = 2.3) +#posición de las etiquetas
   scale_y_continuous(labels = scales::percent, limits = c(0, 0.85)) + #eje y
  labs(title = "Según tamaño de ventas",
       x = NULL,
       y = NULL,
       fill="") +
  theme_minimal(base_family = "Aptos")+
  theme(axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 6),
        plot.title = element_text(hjust = 0.5, size = 7.5),
        legend.position = "bottom",
        legend.title = element_text(size = 5), # Ajustar el tamaño del título de la leyenda
    legend.text = element_text(size = 5.5)    # Ajustar el tamaño del texto de las etiquetas de la leyenda
  ) +
  guides(
    fill = guide_legend(nrow = 2) # Configurar la leyenda para tener 2 filas
  )

#Combinar gráficos
graf_combined <- graf_tam + graf_tamvent +
  plot_layout(ncol = 2) +  # Configurar para que los gráficos estén en 2 columnas (lado a lado)
  plot_annotation(
    caption = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
    theme = theme(plot.title = element_text(family = "Aptos", size = 14, face = "bold"),
      plot.caption = element_text(family = "Aptos", hjust = 0, size = 7.5))
  )

graf_combined


```
\FloatBarrier



```{r, results='asis'}
#| echo: false
#| error: false
#| message: false
#| warning: false

porc_acteco <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "pc_acteco") %>% select(-c("act_eco","empresas", "trabajadores"))

porc_acteco <- round(porc_acteco*100, 1)


orden_acteco <-c("Agricultura, silvicultura y pesca",
                 "Minería",
                 "Industrias manufactureras",
                 "Suministro de electricidad y gas",
                 "Suministro de agua y gestión de  desechos",
                 "Construcción",
                 "Comercio",
                 "Transporte y almacenamiento",
                 "Alojamiento y de servicio de comida",
                 "Información y comunicaciones",
                 "Actividades financieras y de seguros",
                 "Actividades inmobiliarias",
                 "Actividades profesionales y técnicas",
                 "Servicios administrativos y de apoyo")

porc_acteco$act_eco <- orden_acteco

porc_acteco <- porc_acteco |> select(act_eco, pc_empresas, pc_trabajadores)

porc_acteco <- porc_acteco %>% arrange(desc(pc_trabajadores))

orden_empresas<- porc_acteco %>% arrange(desc(pc_empresas))


```

Al revisar la distribución por sector de actividad económica @tbl-acteco se tiene que el sector de `r orden_empresas[1,1]` (`r orden_empresas[1,2]`%) , seguido por el sector `r orden_empresas[2,1] ` (`r orden_empresas[2,2]`%) y el sector de `r orden_empresas[3,1]` (`r orden_empresas[3,2]`%) concentran la mayor cantidad de empresas a nivel nacional. Con respecto al volumen de trabajadores, el sector `r porc_acteco[1,1]`   lidera (`r porc_acteco[1,3]`%) seguido por el sector `r porc_acteco[2,1]` (`r porc_acteco[2,3]`%) y el sector de `r porc_acteco[3,1]` que, siendo sector intensivo en trabajo, un `r porc_acteco[3,2]`% de las empresas acumula el `r porc_acteco[3,3]` de trabajadores y trabajadoras.

\FloatBarrier
```{r, results='asis'}
#| label: tbl-acteco
#| tbl-cap: "Empresas y trabajadores según sector de actividad económica" 
#| echo: false
#| error: false
#| message: false
#| warning: false


porc_acteco <- porc_acteco %>% mutate(pc_empresas = paste0(pc_empresas, "%"),
                                      pc_trabajadores = paste0(pc_trabajadores, "%"))



# Generar la tabla con kable
kable(porc_acteco,
      col.names = c("Actividad Económica", "% Empresas", "% Trabajadores"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>% 
  column_spec(1, width = "9cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 




```
\FloatBarrier

### Estructura corporativa

En este subapartado se analiza la distribución de las empresas a nivel nacional según sus características de estructura corporativa. En primer lugar, se examina el tipo de propiedad de las empresas, diferenciando entre privadas (nacionales o extranjeras), estatales y mixtas. Posteriormente, se estudia la distribución de las empresas que prestan servicios bajo la figura de subcontratación, considerando tanto el sector de actividad económica como la región. Finalmente, se describe la distribución de las organizaciones según su pertenencia a conglomerados y gremios empresariales.

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

Tipo_propiedad <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "Tipo_propiedad") |> mutate(empresas_expandidos= round(empresas_expandidos,0),
                                                                                                      trab_expandidos= round(trab_expandidos,0)) |> filter(tipo!= "Total")


# Calcular la tabla de porcentajes
Tipo_propiedad_pct <- Tipo_propiedad |> mutate(empresas_muestra=(empresas_muestra/sum(empresas_muestra))*100,
                                               empresas_expandidos=(empresas_expandidos/sum(empresas_expandidos))*100,
                                               trab_muestra= (trab_muestra/sum(trab_muestra))*100,
                                               trab_expandidos= (trab_expandidos/sum(trab_expandidos))*100
                                               )
Tipo_propiedad_pct<- as.data.frame(Tipo_propiedad_pct) 

Tipo_propiedad <- Tipo_propiedad |>  bind_rows(summarise(Tipo_propiedad, 
                      tipo = "Total", 
                      empresas_muestra = sum(empresas_muestra),
                      empresas_expandidos = sum(empresas_expandidos),
                      trab_muestra = sum(trab_muestra),
                      trab_expandidos = sum(trab_expandidos)))

Tipo_propiedad <- as.data.frame(Tipo_propiedad)





```

La @tbl-tipo_propiedad muestra la distribución de las empresas según su tipo de propiedad. Se presentan los datos en términos de tamaño muestral de empresas, cantidad de empresas expandidas a nivel poblacional, número de trabajadores en la muestra y trabajadores representados a nivel poblacional.
La gran mayoría de las organizaciones corresponden al tipo de propiedad `r Tipo_propiedad_pct[1,"tipo"]`, que representa el `r round(Tipo_propiedad_pct[1,3],1)`% de las empresas y concentra el `r round(Tipo_propiedad_pct[1,5],1)`% de los trabajadores del país. En contraste, otros tipos de propiedad tienen una representación significativamente menor. Por ejemplo, sólo el `r round(Tipo_propiedad_pct[2,3],1)`% corresponde a empresas del tipo de propiedad `r Tipo_propiedad_pct[2,1]`, lo que equivale a un total del `r round(Tipo_propiedad_pct[2,5],1)`% de los trabajadores del país. A su vez,  el `r round(Tipo_propiedad_pct[3,3],1)`% corresponde a empresas del tipo de propiedad `r Tipo_propiedad_pct[3,1]`, lo que equivale al `r round(Tipo_propiedad_pct[3,5],1)`% de los trabajadores. Y un  `r round(Tipo_propiedad_pct[4,3],1)`% corresponde a empresas del tipo de propiedad `r Tipo_propiedad_pct[4,1]`, conteniendo el `r round(Tipo_propiedad_pct[2,5],1)`% de los trabajadores del país.

```{r, results='asis'}
#| label: tbl-tipo_propiedad
#| tbl-cap: "Tipo de propiedad de empresas" 
#| echo: false
#| error: false
#| message: false
#| warning: false


# Generar la tabla con kable
kable(Tipo_propiedad,
      col.names = c("Tipo de propiedad", "Empresas (Muestra)", "Empresas Estimadas", "Trabajadores (Muestra)", "Trabajadores Estimados"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>% 
  column_spec(1, width = "3cm") %>%
  column_spec(2, width = "2.5cm") %>%
  column_spec(3, width = "2.5cm") %>%
  column_spec(4, width = "2.5cm") %>%
  column_spec(5, width = "2.5cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 

```



```{r, results='asis'}
#| echo: false
#| error: false
#| message: false
#| warning: false


subcontratos_sector <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "subcontratos_sector") |> select(-c(a2)) |> arrange(desc(tot_empresas))

subcontratos_sector<- subcontratos_sector |> select(sector_label, subcontrato_1) |> 
  mutate(subcontrato_1= round((subcontrato_1/sum(subcontrato_1))*100,1)) |> arrange(desc(subcontrato_1))


subcontratos_sector<- as.data.frame(subcontratos_sector)


```

En la @fig-subcontratos_sector  se aprecia la distribución de empresas que prestan servicios a otras empresas a través del subcontrato^[La subcontratación se entiende como el trabajo realizado para un empleador denominado contratista o
subcontratista, quien ejecuta obras o servicios por cuenta y riesgo propio para una empresa principal, dueña de la
obra o faena.] según sector de actividad económica. Los sectores de actividad económica con mayor presencia de empresas que prestan servicios de subcontrato son los sectores de  `r subcontratos_sector[1,1]` (`r (subcontratos_sector[1,2])`%), `r subcontratos_sector[2,1]` (`r (subcontratos_sector[2,2])`%) y `r subcontratos_sector[3,1]` (`r (subcontratos_sector[3,2])`%) respectivamente. Los sectores que tienen menor presencia de empresas que prestan servicios de subcontratación son los sectores de `r subcontratos_sector[12,1]` (`r (subcontratos_sector[12,2])`%), `r subcontratos_sector[13,1]` (`r (subcontratos_sector[13,2])`%) y `r subcontratos_sector[14,1]` (`r (subcontratos_sector[14,2])`%).


```{r,  out.width='100%', fig.align='center', fig.pos='H'}
#| label: fig-subcontratos_sector
#| fig-cap: "Gráfico subcontrato según sector de actividad económica"
#| echo: false
#| fig-align: center
#| error: false
#| message: false
#| warning: false

# Ordenar los sectores de mayor a menor según subcontrato_1
subcontratos_sector <- subcontratos_sector %>%
  mutate(sector_label = reorder(sector_label, subcontrato_1))


#ordenar gráfico por sector de mayor a menor, hacer lo mismo con región
ggplot(subcontratos_sector, aes(x= sector_label, y=subcontrato_1))+
  geom_bar(stat = "identity", width = 0.5,  fill = "#35638c") +
  coord_flip()+
  scale_y_continuous(expand = c(0, 0), labels = scales::comma) +
    geom_text(aes(label = paste0(scales::comma(subcontrato_1), "%")), 
            position = position_stack(vjust = 0.6), 
            color = "white", 
            size = 3) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = ""
  ) +
  theme_classic(base_family = "Aptos") +
  theme(axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7),
         axis.line.x = element_line(color = "grey80"), 
        axis.line.y = element_line(color = "grey80"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 7),
        plot.caption = element_text(size = 7))+
  labs(caption = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.")
  
  


```



```{r, results='asis'}
#| echo: false
#| error: false
#| message: false
#| warning: false


subcontratos_region <-  readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "subcontratos_region") |>  select(-c(reg_muestra)) |> arrange(desc(tot_empresas))
subcontratos_region<- as.data.frame(subcontratos_region)



subcontratos_region<- subcontratos_region |> select(region_label, subcontrato_1) |> 
  mutate(subcontrato_1= round((subcontrato_1/sum(subcontrato_1))*100,1)) 

subcontratos_region<- subcontratos_region |> arrange(desc(subcontrato_1))



```

La @tbl-subcontratos_region indica la distribución de las empresas que prestan servicios bajo la figura del subcontrato según región de ubicación de la empresa, la región de `r subcontratos_region[1,1]` es la que posee la mayor parte (`r subcontratos_region[1,2]`%) de empresas subcontratistas del país. Seguida por la región, del `r subcontratos_region[2,1]` la que concentra el `r subcontratos_region[2,2]`% de empresas subcontratistas. En tercer lugar, la región de `r subcontratos_region[3,1]` posee el `r subcontratos_region[3,2]`% de este tipo de relación contractual. 




```{r, results='asis'}
#| label: tbl-subcontratos_region
#| tbl-cap: "Distribución regional de Empresas que Operan mediante Subcontratación" 
#| echo: false
#| error: false
#| message: false
#| warning: false


 orden_regiones <- c(
    "Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", 
    "Coquimbo", "Valparaíso", "Metropolitana", "O'Higgins", 
    "Maule", "Ñuble", "Biobío", "La Araucanía", 
    "Los Ríos", "Los Lagos", "Aysén", "Magallanes"
  )

# Convertir la columna 'region_label' en factor con el orden deseado
subcontratos_region$region_label <- factor(
  subcontratos_region$region_label,
  levels = orden_regiones
)

# Ordenar el dataframe según los niveles del factor
subcontratos_region <- subcontratos_region[order(subcontratos_region$region_label), ]
rownames(subcontratos_region) <- NULL

subcontratos_region<- as.data.frame(subcontratos_region)

subcontratos_region<- subcontratos_region |> mutate(subcontrato_1= paste0(subcontrato_1, "%"))

# Generar la tabla con kable
kable(subcontratos_region,
      col.names = c("Región", "% Empresas en subcontrato"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>% 
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 


```




```{r, results='asis'}
#| echo: false
#| error: false
#| message: false
#| warning: false


conglomerados_sector <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "conglomerados_sector") |> select(-c(a2)) |> arrange(desc(tot_empresas))

gremios_sector <-  readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "gremios_sector") |>  arrange(desc(tot_empresas))



conglomerados_sector<- conglomerados_sector |>
  select(sector_label,conglomerado_1) |>
  mutate(conglomerado_1= round((conglomerado_1/sum(conglomerado_1))*100,1))


gremios_sector<- gremios_sector |>
  select(sector_label,gremios_1) |>
  mutate(gremios_1= round((gremios_1/sum(gremios_1))*100,1))


conglomerados_gremios <- conglomerados_sector |> left_join(gremios_sector, by= "sector_label")


conglomerados_gremios<- conglomerados_gremios |> arrange(desc(conglomerado_1))


gremios_conglomerados<- conglomerados_gremios |> arrange(desc(gremios_1))


conglomerados_gremios<- as.data.frame(conglomerados_gremios)
gremios_conglomerados<- as.data.frame(gremios_conglomerados)

```

La @tbl-conglomerado_gremio presenta los porcentajes de las empresas que pertencen a conglomerados y gremios^[Un conglomerado es un grupo de empresas dedicadas a negocios no necesariamente relacionados, pero que tienen un controlador o accionista mayoritario común o que se encuentra relacionado mediante pactos o sociedades. Estos conglomerados ejercen control sobre las empresas afiliadas mediante estructuras piramidales, series accionarias preferentes y tenencias cruzadas de acciones (La Porta et al., 1999; Wolfenzon, 1999; Bebchuck, Kraakman y Triantis, 1999). 
En Chile, según el Decreto Ley 2757, los gremios empresariales corresponden a un tipo de asociación voluntaria de empresas que pertenecen a un mismo sector económico o industria, con el propósito de representar y defender intereses comunes]. Se aprecia que los sectores de `r conglomerados_gremios[1,1]` con `r conglomerados_gremios[2,1]` y `r conglomerados_gremios[3,1]` poseen los mayores niveles de empresas conglomeradas con el `r conglomerados_gremios[1,2]`%, `r conglomerados_gremios[2,2]`% y `r conglomerados_gremios[3,2]`% de empresas correspondientes.

Con respecto al poder asociativo de las empresas, el  `r gremios_conglomerados[1,3]`% de las empresas del sector `r gremios_conglomerados[1,1]` pertenecen a un gremio empresarial. De igual forma, el sector `r gremios_conglomerados[2,1]` presenta un `r gremios_conglomerados[2,3]`% de empresas asociadas, mientras que el sector `r gremios_conglomerados[2,3]`%  cuenta con un `r gremios_conglomerados[3,1]` de empresas pertenecientes a algún gremio empresarial.


\FloatBarrier
```{r, results='asis'}
#| label: tbl-conglomerado_gremio
#| tbl-cap: "Empresas pertenecientes a Conglomerados y Gremios" 
#| echo: false
#| error: false
#| message: false
#| warning: false

conglomerados_gremios <- conglomerados_gremios %>% mutate(conglomerado_1 = paste0(conglomerado_1, "%"),
                                      gremios_1 = paste0(gremios_1, "%"))

# Generar la tabla con kable
kable(conglomerados_gremios,
      col.names = c("Actividad Económica", "% Conglomerados", "% Gremios"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>% 
  column_spec(1, width = "11cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 

```
\FloatBarrier

\newpage

## Capítulo II: Demanda Laboral y Ocupaciones de Difícil Cobertura

A continuación, se  identifica y caracteriza la demanda laboral de las empresas durante 2024. En primer lugar, se presentan las cifras relativas a la dotación actual de personal en las empresas, seguido de un análisis de las salidas y contrataciones realizadas para determinar la demanda de trabajo de las organizaciones, incluyendo los principales perfiles ocupacionales contratados, sus competencias y los requisitos asociados.En segundo lugar, se presentan las vacantes actuales^[Número de ofertas de trabajo que se esperan abrir en lo que queda del año 2024.] y futuras^[Número de ofertas de trabajo que se esperan abrir durante el año 2025.]. Para finalizar el análisis se identifican las principales ocupaciones de difícil cobertura presentando las dificultades más relevantes que enfrentan estas posiciones no cubiertas.


### Dotación

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false


dotacion_resumen <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "dotacion_resumen") 


dotacion_resumen<- dotacion_resumen |> mutate(`% mujer`=round(`% mujer`,1),
                                              `% hombre`=round(`% hombre`,1)) |> 
  mutate(`% mujer`=paste0(`% mujer`,"%"),
         `% hombre`=paste0(`% hombre`,"%"))

dotacion_resumen<- dotacion_resumen |> mutate(Total= round(Total,0),
                                              Mujer=round(Mujer,0),
                                              Hombre=round(Hombre,0))

```

En cuanto a la dotación actual de las empresas, la @tbl-dotacion_resumen indica que la cantidad actual de personas empleadas asciende a un total de `r round(dotacion_resumen[4,2],0)` a nivel nacional. Además, se aprecia que la mayor parte de la dotación de trabajadores se encuentra en la categoría de Contrato `r dotacion_resumen[1,1]` con un total de `r round(dotacion_resumen[1,2],0)` trabajadores, de los cuales el `r dotacion_resumen[1,5]` corresponden a mujeres y un  `r dotacion_resumen[1,6]` a personal masculino. Si bien la distribución según sexo del trabajador se mantiene en el resto de categorías contractuales, es la categoría de `r dotacion_resumen[3,1]` donde hay mayor presencia de mujeres trabajadoras, lo que da cuenta de que las mujeres se encuentran en una condición de independencia y flexibilidad, pero al mismo tiempo de mayor inestabilidad y ausencia de protección laboral.



\FloatBarrier
```{r, results='asis'}
#| label: tbl-dotacion_resumen
#| tbl-cap: "Dotación actual de las empresas segpun tipo de relación contractual"
#| echo: false
#| error: false
#| message: false
#| warning: false

# Generar la tabla con kable
kable(dotacion_resumen,
      col.names = c("Categoría", "Total", "Mujer", "Hombre", "% Mujer", "% Hombre"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>% 
  column_spec(1, width = "3cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 

```
\FloatBarrier

### Vacantes y Salidas

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

vacantes_actuales_futuras <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "vacantes_actuales_futuras") 

#Vacantes actuales y futuras
vacantes_actuales_futuras <- pivot_longer(
  vacantes_actuales_futuras, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)

vacantes_actuales_futuras<-  vacantes_actuales_futuras |> mutate(Columna= case_when(Columna=="actuales"~ "Vacantes actuales",
                                                Columna=="futuras_actuales"~ "Vacantes futuras 2024",
                                                Columna=="futuras_prox_ano"~ "Vacantes futuras 2025"))

```

La @fig-vacantes presenta las vacantes actuales^[Número de ofertas de trabajo o vacantes abiertas al 31 de mayo del 2024.] y las vacantes futuras, que corresponden a la cantidad estimada de puestos de trabajo que se abrirán en los próximos doce meses. Actualmente, existen `r round(vacantes_actuales_futuras[1,2],0)` vacantes disponibles. En cuanto a las vacantes futuras, estas se dividen en dos categorías: los puestos de trabajo previstos para el resto del año 2024 (`r round(vacantes_actuales_futuras[2,2],0)`) y las ofertas de empleo proyectadas para el año 2025 (`r round(vacantes_actuales_futuras[3,2],0)`).

\FloatBarrier
```{r, fig.cap="Gráfico vacantes", out.width='100%', fig.align='center', fig.pos='H'}
#| label: fig-vacantes
#| fig-cap: "Gráfico Vacantes"
#| echo: false
#| fig-align: center
#| error: false
#| message: false
#| warning: false


# Crear el gráfico con el data frame
ggplot(data = vacantes_actuales_futuras, aes(x = Columna, y = Valor, fill = Columna)) +
  geom_bar(stat = "identity", width = 0.3) +
  scale_fill_manual(values = c(
    "Vacantes actuales" = "#e36444", 
    "Vacantes futuras 2024" = "#35638c",
    "Vacantes futuras 2025" = "#bb1c42"
  )) +
  geom_text(aes(label =scales::comma(Valor)), 
            position = position_stack(vjust = 0.5), 
            color = "white", 
            size = 3.5) +
  coord_flip()+
  scale_x_discrete(expand = c(0.5, 0)) + 
  scale_y_continuous(expand = c(0, 0), labels = scales::comma) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Cantidad de Personas"
  ) +
  theme_classic(base_family = "Aptos") +
  theme(axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7),
         axis.line.x = element_line(color = "grey80"), 
        axis.line.y = element_line(color = "grey80"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 7),
        plot.caption = element_text(size = 7))+
  labs(caption = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.")


```


```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false
#Mantener el orden de estas tablas

renuncia_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "renuncia_total") 
despidos_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "despidos_total") 
contrataciones_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "contrataciones_total") 
vacantes_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "vacantes_total") # Este se incrusta pero no se grafica

renuncia_total <- renuncia_total |> mutate(renuncia_mujer=round((renuncia_mujer/renuncia_total)*100,1),
                                           renuncia_hombre=round((renuncia_hombre/renuncia_total)*100,1))

despidos_total <- despidos_total |> mutate(despidos_mujer=round((despidos_mujer/despidos_total)*100,1),
                                           despidos_hombre=round((despidos_hombre/despidos_total)*100,1))

contrataciones_total<- contrataciones_total |> mutate(contrataciones_mujer=round((contrataciones_mujer/contrataciones_total)*100,1),
                                           contrataciones_hombre=round((contrataciones_hombre/contrataciones_total)*100,1))




renuncia_total <- pivot_longer(
  renuncia_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)


renuncia_total<-  renuncia_total |> mutate(Columna= case_when(Columna=="renuncia_total"~ "Total",
                                                Columna=="renuncia_mujer"~ "Mujer",
                                                Columna=="renuncia_hombre"~ "Hombre"),
                                           condicion="Renuncias")


despidos_total <- pivot_longer(
  despidos_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)

despidos_total<-  despidos_total |> mutate(Columna= case_when(Columna=="despidos_total"~ "Total",
                                                Columna=="despidos_mujer"~ "Mujer",
                                                Columna=="despidos_hombre"~ "Hombre"),
                                           condicion="Despidos y ceses")


contrataciones_total <- pivot_longer(
  contrataciones_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)


contrataciones_total<-  contrataciones_total |> mutate(Columna= case_when(Columna=="contrataciones_total"~ "Total",
                                                Columna=="contrataciones_mujer"~ "Mujer",
                                                Columna=="contrataciones_hombre"~ "Hombre"),
                                                condicion="Contrataciones")

#Total
totales <- rbind(contrataciones_total, renuncia_total, despidos_total)

totales <- totales |> filter(Columna != "Total")
totales <- as.data.frame(totales)

renuncia_total<- as.data.frame(renuncia_total)
despidos_total<- as.data.frame(despidos_total)


```

En la @fig-salidas_contrataciones aparecen los porcentajes correspondientes a las salidas (renuncias, despidos o ceses)^[Renuncias y Ceses, terminaciones de empleados/as
permanentes, de corto plazo o estacionales.] y contrataciones diferenciando por sexo de los trabajadores. Durante los últimos 12 meses a nivel nacional hubo un total de `r round(renuncia_total[1,2],0)` renuncias, de las cuales el `r renuncia_total[2,2]`% corresponde a renuncias hechas por mujeres, mientras que  el `r renuncia_total[3,2]`% de estas corresponden a renuncias hechas por hombres.

En cuanto a despidos (y ceses) ^[Ceses, terminaciones de empleados/as permanentes, de corto plazo o estacionales.], en el gráfico se observa que  a nivel nacional existió un total de `r round(despidos_total[1,2],0)`, de los cuales el `r despidos_total[2,2]`% corresponde a casos de despidos o terminaciones de empleos ocupados por mujeres, y un `r despidos_total[3,2]`%  corresponde a despidos o ceses cuyos puestos de trabajos eran ocupados por hombres.

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false
renuncia_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "renuncia_total") 
despidos_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "despidos_total") 
contrataciones_total <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "contrataciones_total") 


renuncia_total <- pivot_longer(
  renuncia_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)


renuncia_total<-  renuncia_total |> mutate(Columna= case_when(Columna=="renuncia_total"~ "Total",
                                                Columna=="renuncia_mujer"~ "Mujer",
                                                Columna=="renuncia_hombre"~ "Hombre"),
                                           condicion="Renuncias")


despidos_total <- pivot_longer(
  despidos_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)

despidos_total<-  despidos_total |> mutate(Columna= case_when(Columna=="despidos_total"~ "Total",
                                                Columna=="despidos_mujer"~ "Mujer",
                                                Columna=="despidos_hombre"~ "Hombre"),
                                           condicion="Despidos y ceses")


contrataciones_total <- pivot_longer(
  contrataciones_total, 
  cols = everything(), 
  names_to = "Columna", 
  values_to = "Valor"
)


contrataciones_total<-  contrataciones_total |> mutate(Columna= case_when(Columna=="contrataciones_total"~ "Total",
                                                Columna=="contrataciones_mujer"~ "Mujer",
                                                Columna=="contrataciones_hombre"~ "Hombre"),
                                                condicion="Contrataciones")

#Total
totales <- rbind(contrataciones_total, renuncia_total, despidos_total)

totales <- totales |> filter(Columna != "Total")
totales <- as.data.frame(totales)

totales$Valor <-  round(totales$Valor, 0)

# Transformar los valores de las categorías específicas en negativos
totales <- totales %>%
  mutate(Valor = ifelse(condicion %in% c("Renuncias", "Despidos y ceses"), -Valor, Valor))



```


\FloatBarrier
```{r, fig.cap="Gráfico salidas y contrataciones", out.width='100%', fig.align='center', fig.pos='H'}
#| label: fig-salidas_contrataciones
#| fig-cap: "Gráfico salidas y contrataciones"
#| echo: false
#| fig-align: center
#| error: false
#| message: false
#| warning: false


# Crear el gráfico de barras
ggplot(data = totales, aes(x = condicion, y = Valor, fill = Columna)) +
  geom_bar(position="stack",stat = "identity",  width = 0.3 ) +
  scale_fill_manual(values = c(
    "Mujer" = "#e36444", 
    "Hombre" = "#35638c"
  )) +
  geom_hline(yintercept = 0, color = "grey80", linetype = "solid", size = 0.5) + 
  coord_flip()+
geom_text(aes(label = scales::number(abs(Valor), accuracy = 1), group = Columna), 
            position = position_stack(vjust = 0.5), 
            color = "white", 
            size = 3)+
  scale_y_continuous(expand = c(0, 0), labels = scales::comma, limits = c(-11000000, 11000000))  +
  scale_x_discrete(expand = expansion(mult = c(0.9, 0.9)))+ # Ajusta para cambiar el espacio
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Cantidad de Personas"
  ) +
  theme_classic(base_family = "Aptos") +
  theme(axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
         axis.line.x = element_line(color = "grey80"), 
        axis.line.y = element_line(color = "grey80"),
        plot.title = element_text(hjust = 0.5, size = 7.5),
        legend.position = "bottom",
        legend.title = element_blank(), # Ajustar el tamaño del título de la leyenda
    legend.text = element_text(size = 7),
    plot.caption = element_text(size = 7)) +
  labs(caption = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos." )

```

### Contrataciones últimos 12 meses

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false


contratados_u12 <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "contratados_u12") #Vacantes contratadas los últimos 12 meses

contratados_u12<- contratados_u12 %>%select(c("c1", "oficio_label","c1_c_1", "cv"))
contratados_u12<- contratados_u12 %>% filter(cv<0.50) %>% arrange(desc(c1_c_1)) %>% head(.,11)
contratados_u12<- contratados_u12 |> mutate(c1_c_1= round(c1_c_1,0),
                                             cv= round((cv)*100,1))



```


La @tbl-contratados_u12 sólo muestra aquellas ocupaciones para las cuáles el coeficiente de variación es menor a 50%^[La convención es considerar cómo robustas estimaciones con un cv menor al 15%. Dado que estas son pocas, se presentan todas las ocupaciones con un cv menor a 50%.].
Las ocupaciones más contratadas en los últimos 12 meses fueron "`r contratados_u12[1,2]`" con `r contratados_u12[1,3]` contrataciones, en segundo lugar con `r contratados_u12[2,3]` contrataciones, "`r contratados_u12[2,2]`"  y "`r contratados_u12[3,2]`" con `r contratados_u12[3,3]` contrataciones.
\FloatBarrier
```{r, results='asis'}
#| label: tbl-contratados_u12
#| tbl-cap: "Contratados últimos 12 meses, por ocupación." 
#| echo: false
#| error: false
#| message: false
#| warning: false


contratados_u12 <- contratados_u12 %>% mutate(cv = paste0(cv, "%"))

# Generar la tabla con kable
kable(contratados_u12,
      col.names = c("CIUO_08", "Glosa", "Contratados", "cv"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>%
  column_spec(2, width = "10cm") %>% 
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 

```
\FloatBarrier


```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false
#| 
contratos_totales <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "contratados_u12_sector")

contratos_totales<- contratos_totales |> group_by(sector_label,a2) |> summarise(c1_c_1=sum(c1_c_1)) |> ungroup()


contratos_totales<-contratos_totales |> select(sector_label,c1_c_1) |> mutate(c1_c_1= round(c1_c_1,0)) |>  arrange(desc(c1_c_1))


```

La @tbl-contratados_sector muestra la comparativa entre los sectores de actividad económica con respecto a la cantidad de puestos de trabajos contratados los últimos 12 meses, el sector de `r contratos_totales[1,1]` con `r contratos_totales[1,2]` contrataciones. En segundo lugar, el sector de `r contratos_totales[2,1]` contrató un total de `r contratos_totales[2,2]` personas, seguido del sector de `r contratos_totales[3,1]` con un total de  `r contratos_totales[3,2]` ocupaciones contratadas durante los últimos 12 meses. Dentro de los sectores que menos vacantes contratados tuvieron fueron los sectores de `r contratos_totales[12,1]` con `r contratos_totales[12,2]` puestos de trabajo, el sector `r contratos_totales[13,1]` con `r contratos_totales[13,2]` vacantes contratadas y el sector `r contratos_totales[14,1]` con `r contratos_totales[14,2]` vacantes contratadas durante el último año.

\FloatBarrier
```{r, results='asis',  out.width='100%', fig.align='center', fig.pos='H'}
#| label: tbl-contratados_sector
#| tbl-cap: "Contratados últimos 12 meses por sector de actividad económica." 
#| echo: false
#| error: false
#| message: false
#| warning: false


# Generar la tabla con kable
kable(contratos_totales,
      col.names = c("Glosa", "Contratados"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>%
  column_spec(1, width = "9cm") %>% 
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 

 

```



### Ocupaciones de Difícil Cobertura

Las ocupaciones de difícil cobertura son aquellas ocupaciones o puestos de trabajo que los empleadores encuentran difíciles de cubrirpor diferentes causas como la escasez de trabajadores con las competencias, habilidades o experiencia necesarias. Estas dificultades pueden originarse por la falta de oferta de mano de obra calificada, brechas de habilidades técnicas o blandas, condiciones laborales poco atractivas (como salarios bajos o jornadas extensas), o problemas de localización geográfica que limitan el acceso a trabajadores en regiones específicas. Identificar estas ocupaciones permite entender las dinámicas del mercado laboral y los desafíos que enfrentan distintos sectores productivos del país.

Medir este tipo de ocupaciones es fundamental porque facilita el emparejamiento (**match**) entre la oferta y la demanda laboral, orientando programas de capacitación y formación hacia las necesidades reales del mercado. Además, ayuda a optimizar los procesos de intermediación laboral y permite anticipar tendencias, ayudando a trabajadores y estudiantes a tomar decisiones informadas sobre su desarrollo profesional. Al mismo tiempo, contribuye a reducir desigualdades regionales al focalizar esfuerzos en zonas rezagadas, fortaleciendo el capital humano y mejorando la competitividad del país. En síntesis, esta medición es clave para implementar políticas públicas más efectivas y promover una fuerza laboral adaptada a los desafíos económicos actuales y futuros.

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

cuadro8_odc <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "cuadro8_odc") 


cuadro8_odc <- cuadro8_odc %>% filter(cv<0.4 & cv!=0) %>% 
  filter(n_region==0) %>% 
  mutate(d2=round(d2,0),
         cv=round(cv*100,1)) %>% 
  arrange(desc(d2)) %>% 
  select(d3,oficio_label, d2, cv)

```

La @tbl-cuadro8_odc sólo muestra aquellas para las cuáles el coeficiente de variación es menor a 40%^[La convención es considerar cómo robustas estimaciones con un cv menor al 15%. Dado que esto no se cumple, se presentan todas las ocupaciones con un cv menor a 40%.]. La ocupación más dificiles de cubrir es la de `r cuadro8_odc[1,2]` con un total de `r cuadro8_odc[1,3]` vacantes sin llenar. En segundo lugar, la ocupación `r cuadro8_odc[2,2]` tuvo un total de `r cuadro8_odc[2,3]` vacantes sin llenar. La ocupación de `r cuadro8_odc[3,2]` tuvo un total de `r cuadro8_odc[3,3]` vacantes sin cubrir. 



```{r, fig.align='center'}
#| label: tbl-cuadro8_odc
#| tbl-cap: "Ocupaciones de difícil cobertura, ENADEL 2024."
#| echo: false
#| error: false
#| message: false
#| warning: false

cuadro8_odc<- cuadro8_odc %>% mutate(cv= paste0(cv, "%"))

# Generar la tabla con kable
kable(cuadro8_odc,
      col.names = c("CIUO 08", "Glosa", "Vacantes", "CV"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>%
  column_spec(2, width = "9cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "") 
```

### Principales Dificultades

```{r}
#| echo: false
#| error: false
#| message: false
#| warning: false

options(OutDec = ",")

dificultad_tot <- readxl::read_xlsx("../Tablas/porcentajes.xlsx", sheet = "dificultad_tot")

#Recodificación
dificultad_tot <- dificultad_tot %>%
  mutate(dif1 = round((oficios.x / sum(oficios.x)) * 100, 1),
         total= oficios.x+ oficios.y + oficios) %>% 
  select(dif_label,dif1, total)


dificultad_tot <- dificultad_tot %>% mutate(total=round((total/sum(total))*100,1)) %>% arrange(desc(total))
dificultad_tot<-as.data.frame(dificultad_tot)


```

La @tbl-dificultad muestra las principales dificultades de contratación. La dificultad más reportada es la de "`r dificultad_tot[1,1]`", presente en el `r dificultad_tot[1,3]`% de los casos, seguida por "`r dificultad_tot[2,1]`" con un `r dificultad_tot[2,3]`% y "`r dificultad_tot[3,1]`", que representa el `r dificultad_tot[3,3]`% del total de los principales cargos con dificultades de contratación.


```{r}
#| label: tbl-dificultad
#| tbl-cap: "Dificultades de contratación."
#| echo: false
#| error: false
#| message: false
#| warning: false

dificultad_tot<- dificultad_tot %>% mutate(dif1= paste0(dif1, "%"),
                                           total= paste0(total, "%"))

# Generar la tabla con kable
kable(dificultad_tot,
      col.names = c("Primera dificultad", "% de 1ra dificultad", "% del total"),
      format = "latex", 
      booktabs = TRUE) %>% 
  kable_classic(full_width = FALSE, html_font = "Aptos") %>%
  column_spec(1, width = "10cm") %>%
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "3cm") %>%
  footnote(general = "Fuente: Elaboración propia utilizando datos de ENADEL 2024, datos expandidos.",
            general_title= "")
```

\newpage

## Capítulo III: Capacitación y Habilidades


### Organismo Técnico Intermedio para capacitación


### Capacitaciones de la empresa


### Competencias en que se capacita


### Fuentes de financiamiento de la capacitación 


## Capítulo IV: Transiciones


### Eventos climáticos extremos

### Medidas de Cuidado del medioambiente

### Digitalización y Automatización

#### Cambios en dotación de personal

#### Creación de nuevos puestos de trabajo

#### Dificultad para llenar vacantes 




